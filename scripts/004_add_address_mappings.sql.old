-- Address Mappings Table for Algorand Identity Binding
-- This table maps hashed email addresses to Algorand wallet addresses
-- Used for "Sign-in with Algorand" functionality

CREATE TABLE IF NOT EXISTS address_mappings (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  email_hash TEXT UNIQUE NOT NULL,
  algorand_address TEXT NOT NULL,
  last_signed_in TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Create index for fast lookups
CREATE INDEX IF NOT EXISTS idx_address_mappings_email_hash 
ON address_mappings(email_hash);

CREATE INDEX IF NOT EXISTS idx_address_mappings_algorand_address 
ON address_mappings(algorand_address);

-- Add RLS (Row Level Security) policies
ALTER TABLE address_mappings ENABLE ROW LEVEL SECURITY;

-- Policy: Users can read their own mappings
CREATE POLICY "Users can read own address mappings"
ON address_mappings
FOR SELECT
USING (true);  -- Adjust based on your auth requirements

-- Policy: Users can insert their own mappings
CREATE POLICY "Users can insert address mappings"
ON address_mappings
FOR INSERT
WITH CHECK (true);  -- Adjust based on your auth requirements

-- Policy: Users can update their own mappings
CREATE POLICY "Users can update own address mappings"
ON address_mappings
FOR UPDATE
USING (true)  -- Adjust based on your auth requirements
WITH CHECK (true);
